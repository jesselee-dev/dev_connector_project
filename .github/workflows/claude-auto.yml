name: Claude Auto Commit

on:
  schedule:
    - cron: "*/10 * * * *" # æ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  run-claude:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ğŸ§© æ£€æŸ¥æ˜¯å¦å­˜åœ¨ ChatGPT çš„å®¡æŸ¥åé¦ˆ
      - name: Check for supervisor feedback
        run: |
          if [ -f "logs/review.txt" ]; then
            echo "ğŸ§© Found supervisor feedback. Sending it to Claude..."
            export REVIEW_CONTENT=$(cat logs/review.txt | jq -Rs .)
          else
            echo "â„¹ï¸ No review found. Using default prompt."
            export REVIEW_CONTENT="No previous feedback."
          fi
          echo "REVIEW_CONTENT=$REVIEW_CONTENT" >> $GITHUB_ENV

      # ğŸ§  è°ƒç”¨ Claude API ç”Ÿæˆæ–°ç»“æœ
      - name: Run Claude API task
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          mkdir -p logs
          echo "ğŸ§  Running Claude with supervisor feedback..."
          RESPONSE=$(curl https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "content-type: application/json" \
            -d '{
              "model": "claude-3-sonnet-20240229",
              "max_tokens": 1000,
              "messages": [
                {"role": "system", "content": "You are an autonomous developer that continuously improves this repository based on feedback from your supervisor."},
                {"role": "user", "content": "Supervisor feedback:\n'"$REVIEW_CONTENT"'\n\nNow continue improving the project accordingly and describe what you changed."}
              ]
            }' | jq -r '.content[0].text')

          echo "$RESPONSE" > logs/output.txt
          echo "âœ… Claude output saved to logs/output.txt"

      # ğŸ’¾ æäº¤å¹¶æ¨é€ç»“æœ
      - name: Commit and push results
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config user.name "Claude Auto"
          git config user.email "claude@automation.bot"
          git add logs/output.txt
          git commit -m "ğŸ¤– Auto update via Claude at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
          git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} main
